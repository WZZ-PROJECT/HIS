{"remainingRequest":"E:\\XM\\his-shopping-h5\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\XM\\his-shopping-h5\\src\\views\\order\\checkout.vue?vue&type=script&lang=js&","dependencies":[{"path":"E:\\XM\\his-shopping-h5\\src\\views\\order\\checkout.vue","mtime":1606186248939},{"path":"E:\\XM\\his-shopping-h5\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\XM\\his-shopping-h5\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"E:\\XM\\his-shopping-h5\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"E:\\XM\\his-shopping-h5\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport { Card, Tag, ard, Field, SubmitBar, Toast  } from 'vant';\r\nimport { CouponCell, CouponList, Popup } from 'vant';\r\nimport { cartCheckout, orderSubmit, couponSelectList} from '@/api/api';\r\nimport { getLocalStorage, setLocalStorage } from '@/utils/local-storage';\r\nimport dayjs from 'dayjs';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      checkedGoodsList: [],\r\n      checkedAddress: {},\r\n      availableCouponLength: 0, // 可用的优惠券数量\r\n      goodsTotalPrice: 0, //商品总价\r\n      freightPrice: 0, //快递费\r\n      couponPrice: 0, //优惠券的价格\r\n      grouponPrice: 0, //团购优惠价格\r\n      orderTotalPrice: 0, //订单总价\r\n      actualPrice: 0, //实际需要支付的总价\r\n      message: '',\r\n\r\n      isDisabled: false,\r\n      showList: false,\r\n      chosenCoupon: -1,\r\n      coupons: [],\r\n      disabledCoupons: [] \r\n    };\r\n  },\r\n  created() {\r\n    this.init();\r\n  },\r\n\r\n  methods: {\r\n    onSubmit() {     \r\n      const {AddressId, CartId, CouponId, UserCouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId', 'UserCouponId');\r\n\r\n      if (AddressId === null) {\r\n        Toast.fail('请设置收货地址');\r\n        return;\r\n      }\r\n\r\n\r\n      this.isDisabled = true;\r\n\r\n      orderSubmit({\r\n        addressId: AddressId,\r\n        cartId: CartId,\r\n        couponId: CouponId,\r\n        userCouponId: UserCouponId,\r\n        grouponLinkId: 0,\r\n        grouponRulesId: 0,\r\n        message: this.message\r\n      }).then(res => {\r\n        \r\n        // 下单成功，重置下单参数。\r\n        setLocalStorage({AddressId: 0, CartId: 0, CouponId: 0});\r\n\r\n        let orderId = res.data.data.orderId;\r\n        this.$router.push({\r\n          name: 'payment',\r\n          params: { orderId: orderId }\r\n        });\r\n      }).catch(error => {\r\n        this.isDisabled = false;\r\n        this.$toast(\"下单失败\");\r\n      })\r\n\r\n    },\r\n    goAddressList() {\r\n      this.$router.push({\r\n        path: '/user/address',\r\n        query: {\r\n          from: 'shopcar'\r\n        }\r\n      });\r\n    },\r\n    getCouponValue() {\r\n      if(this.couponPrice !== 0 ){\r\n        return \"-¥\" + this.couponPrice + \".00元\"\r\n      }\r\n      if(this.availableCouponLength !== 0){\r\n        return this.availableCouponLength + \"张可用\"\r\n      }\r\n      return '没有可用优惠券'\r\n    },\r\n    getCoupons() {\r\n      const {AddressId, CartId, CouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId');\r\n      couponSelectList({cartId: CartId, grouponRulesId: 0}).then(res => {\r\n        var cList = res.data.data.list;\r\n        this.coupons = []\r\n        this.disabledCoupons = [];\r\n        for(var i = 0; i < cList.length; i++){\r\n          var c = cList[i]\r\n\r\n          var coupon = {\r\n            id: c.id,\r\n            cid: c.cid,\r\n            name: c.name,\r\n            condition: '满' + c.min + '元可用',\r\n            value: c.discount * 100,\r\n            description: c.desc,\r\n            startAt: new Date(c.startTime).getTime()/1000,\r\n            endAt: new Date(c.endTime).getTime()/1000,\r\n            valueDesc: c.discount,\r\n            unitDesc: '元'            \r\n          }\r\n          if (c.available) {\r\n            this.coupons.push(coupon);\r\n          } else {\r\n            this.disabledCoupons.push(coupon);\r\n          }\r\n        }\r\n        \r\n        this.showList = true\r\n      })\r\n    },\r\n    init() {\r\n      const {AddressId, CartId, CouponId, UserCouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId', 'UserCouponId');\r\n\r\n      cartCheckout({cartId: CartId, addressId: AddressId, couponId: CouponId, userCouponId: UserCouponId, grouponRulesId: 0}).then(res => {\r\n          var data = res.data.data\r\n\r\n          this.checkedGoodsList = data.checkedGoodsList;\r\n          this.checkedAddress= data.checkedAddress;\r\n          this.availableCouponLength= data.availableCouponLength;\r\n          this.actualPrice= data.actualPrice;\r\n          this.couponPrice= data.couponPrice;\r\n          this.grouponPrice= data.grouponPrice;\r\n          this.freightPrice= data.freightPrice;\r\n          this.goodsTotalPrice= data.goodsTotalPrice;\r\n          this.orderTotalPrice= data.orderTotalPrice;\r\n\r\n          setLocalStorage({AddressId: data.addressId, CartId: data.cartId, CouponId: data.couponId, UserCouponId: data.userCouponId});\r\n      });\r\n\r\n    },\r\n    onChange(index) {\r\n      this.showList = false;\r\n      this.chosenCoupon = index;\r\n      \r\n      if(index === -1 ){\r\n        setLocalStorage({CouponId: -1, UserCouponId: -1});\r\n      }\r\n      else{\r\n        const couponId = this.coupons[index].cid;\r\n        const userCouponId = this.coupons[index].id;\r\n        setLocalStorage({CouponId: couponId, UserCouponId: userCouponId});\r\n      }\r\n\r\n      this.init()\r\n    },\r\n    onExchange() {\r\n      this.$toast(\"兑换暂不支持\");\r\n    }    \r\n  },\r\n\r\n  components: {\r\n    [Toast.name]: Toast ,\r\n    [SubmitBar.name]: SubmitBar,\r\n    [Card.name]: Card,\r\n    [Field.name]: Field,\r\n    [Tag.name]: Tag,\r\n    [CouponCell.name]: CouponCell,\r\n    [CouponList.name]: CouponList,\r\n    [Popup.name]: Popup\r\n  }\r\n};\r\n",{"version":3,"sources":["checkout.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0EA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"checkout.vue","sourceRoot":"src/views/order","sourcesContent":["<template>\r\n<div class=\"order\">\r\n  <van-cell-group>\r\n      <van-cell v-if=\"checkedAddress\" isLink @click=\"goAddressList()\" title=\"收货地址\">\r\n      <div slot=\"label\">\r\n        <div>\r\n         <span>{{ checkedAddress.name }} </span>\r\n         <span>{{ checkedAddress.tel }} </span>\r\n      </div>\r\n      <div>\r\n        {{ checkedAddress.addressDetail }}\r\n      </div>\r\n      </div>\r\n    </van-cell>\r\n  </van-cell-group>\r\n\r\n  <van-cell-group>\r\n    <van-cell class=\"order-coupon\" title=\"优惠券\" is-link :value=\"getCouponValue()\" @click=\"getCoupons\" />\r\n  </van-cell-group>\r\n\r\n<!-- 优惠券列表 -->\r\n<van-popup v-model=\"showList\" position=\"bottom\">\r\n  <van-coupon-list\r\n    :coupons=\"coupons\"\r\n    :chosen-coupon=\"chosenCoupon\"\r\n    :disabled-coupons=\"disabledCoupons\"\r\n    @change=\"onChange\"\r\n    @exchange=\"onExchange\"\r\n  />\r\n</van-popup>\r\n\r\n    <van-card\r\n      v-for=\"item in checkedGoodsList\"\r\n      :key=\"item.id\"\r\n      :title=\"item.goodsName\"\r\n      :num=\"item.number\"\r\n      :price=\"item.price +'.00'\"\r\n      :thumb=\"item.picUrl\"\r\n    >\r\n      <div slot=\"desc\">\r\n        <div class=\"van-card__desc\">\r\n          <van-tag plain style=\"margin-right:6px;\" v-for=\"(spec, index) in item.specifications\" :key=\"index\">\r\n            {{spec}}\r\n          </van-tag>\r\n        </div>\r\n      </div>\r\n    </van-card>\r\n\r\n    <van-cell-group>\r\n      <van-cell title=\"商品金额\">\r\n        <span class=\"red\">{{goodsTotalPrice * 100 | yuan}}</span>\r\n      </van-cell>\r\n      <van-cell title=\"邮费\">\r\n        <span class=\"red\">{{ freightPrice * 100| yuan}}</span>\r\n      </van-cell>\r\n      <van-cell title=\"优惠券\">\r\n        <span class=\"red\">-{{ couponPrice * 100| yuan}}</span>\r\n      </van-cell>\r\n      <van-field v-model=\"message\" placeholder=\"请输入备注\" label=\"订单备注\">\r\n      <template slot=\"icon\">{{message.length}}/50</template>\r\n      </van-field>      \r\n    </van-cell-group>\r\n\r\n    <van-submit-bar\r\n      :price=\"actualPrice*100\"\r\n      label=\"总计：\"\r\n      buttonText=\"提交订单\"\r\n      :disabled=\"isDisabled\"\r\n      @submit=\"onSubmit\"\r\n    />\r\n</div>\r\n</template>\r\n\r\n<script>\r\nimport { Card, Tag, ard, Field, SubmitBar, Toast  } from 'vant';\r\nimport { CouponCell, CouponList, Popup } from 'vant';\r\nimport { cartCheckout, orderSubmit, couponSelectList} from '@/api/api';\r\nimport { getLocalStorage, setLocalStorage } from '@/utils/local-storage';\r\nimport dayjs from 'dayjs';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      checkedGoodsList: [],\r\n      checkedAddress: {},\r\n      availableCouponLength: 0, // 可用的优惠券数量\r\n      goodsTotalPrice: 0, //商品总价\r\n      freightPrice: 0, //快递费\r\n      couponPrice: 0, //优惠券的价格\r\n      grouponPrice: 0, //团购优惠价格\r\n      orderTotalPrice: 0, //订单总价\r\n      actualPrice: 0, //实际需要支付的总价\r\n      message: '',\r\n\r\n      isDisabled: false,\r\n      showList: false,\r\n      chosenCoupon: -1,\r\n      coupons: [],\r\n      disabledCoupons: [] \r\n    };\r\n  },\r\n  created() {\r\n    this.init();\r\n  },\r\n\r\n  methods: {\r\n    onSubmit() {     \r\n      const {AddressId, CartId, CouponId, UserCouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId', 'UserCouponId');\r\n\r\n      if (AddressId === null) {\r\n        Toast.fail('请设置收货地址');\r\n        return;\r\n      }\r\n\r\n\r\n      this.isDisabled = true;\r\n\r\n      orderSubmit({\r\n        addressId: AddressId,\r\n        cartId: CartId,\r\n        couponId: CouponId,\r\n        userCouponId: UserCouponId,\r\n        grouponLinkId: 0,\r\n        grouponRulesId: 0,\r\n        message: this.message\r\n      }).then(res => {\r\n        \r\n        // 下单成功，重置下单参数。\r\n        setLocalStorage({AddressId: 0, CartId: 0, CouponId: 0});\r\n\r\n        let orderId = res.data.data.orderId;\r\n        this.$router.push({\r\n          name: 'payment',\r\n          params: { orderId: orderId }\r\n        });\r\n      }).catch(error => {\r\n        this.isDisabled = false;\r\n        this.$toast(\"下单失败\");\r\n      })\r\n\r\n    },\r\n    goAddressList() {\r\n      this.$router.push({\r\n        path: '/user/address',\r\n        query: {\r\n          from: 'shopcar'\r\n        }\r\n      });\r\n    },\r\n    getCouponValue() {\r\n      if(this.couponPrice !== 0 ){\r\n        return \"-¥\" + this.couponPrice + \".00元\"\r\n      }\r\n      if(this.availableCouponLength !== 0){\r\n        return this.availableCouponLength + \"张可用\"\r\n      }\r\n      return '没有可用优惠券'\r\n    },\r\n    getCoupons() {\r\n      const {AddressId, CartId, CouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId');\r\n      couponSelectList({cartId: CartId, grouponRulesId: 0}).then(res => {\r\n        var cList = res.data.data.list;\r\n        this.coupons = []\r\n        this.disabledCoupons = [];\r\n        for(var i = 0; i < cList.length; i++){\r\n          var c = cList[i]\r\n\r\n          var coupon = {\r\n            id: c.id,\r\n            cid: c.cid,\r\n            name: c.name,\r\n            condition: '满' + c.min + '元可用',\r\n            value: c.discount * 100,\r\n            description: c.desc,\r\n            startAt: new Date(c.startTime).getTime()/1000,\r\n            endAt: new Date(c.endTime).getTime()/1000,\r\n            valueDesc: c.discount,\r\n            unitDesc: '元'            \r\n          }\r\n          if (c.available) {\r\n            this.coupons.push(coupon);\r\n          } else {\r\n            this.disabledCoupons.push(coupon);\r\n          }\r\n        }\r\n        \r\n        this.showList = true\r\n      })\r\n    },\r\n    init() {\r\n      const {AddressId, CartId, CouponId, UserCouponId} = getLocalStorage('AddressId', 'CartId', 'CouponId', 'UserCouponId');\r\n\r\n      cartCheckout({cartId: CartId, addressId: AddressId, couponId: CouponId, userCouponId: UserCouponId, grouponRulesId: 0}).then(res => {\r\n          var data = res.data.data\r\n\r\n          this.checkedGoodsList = data.checkedGoodsList;\r\n          this.checkedAddress= data.checkedAddress;\r\n          this.availableCouponLength= data.availableCouponLength;\r\n          this.actualPrice= data.actualPrice;\r\n          this.couponPrice= data.couponPrice;\r\n          this.grouponPrice= data.grouponPrice;\r\n          this.freightPrice= data.freightPrice;\r\n          this.goodsTotalPrice= data.goodsTotalPrice;\r\n          this.orderTotalPrice= data.orderTotalPrice;\r\n\r\n          setLocalStorage({AddressId: data.addressId, CartId: data.cartId, CouponId: data.couponId, UserCouponId: data.userCouponId});\r\n      });\r\n\r\n    },\r\n    onChange(index) {\r\n      this.showList = false;\r\n      this.chosenCoupon = index;\r\n      \r\n      if(index === -1 ){\r\n        setLocalStorage({CouponId: -1, UserCouponId: -1});\r\n      }\r\n      else{\r\n        const couponId = this.coupons[index].cid;\r\n        const userCouponId = this.coupons[index].id;\r\n        setLocalStorage({CouponId: couponId, UserCouponId: userCouponId});\r\n      }\r\n\r\n      this.init()\r\n    },\r\n    onExchange() {\r\n      this.$toast(\"兑换暂不支持\");\r\n    }    \r\n  },\r\n\r\n  components: {\r\n    [Toast.name]: Toast ,\r\n    [SubmitBar.name]: SubmitBar,\r\n    [Card.name]: Card,\r\n    [Field.name]: Field,\r\n    [Tag.name]: Tag,\r\n    [CouponCell.name]: CouponCell,\r\n    [CouponList.name]: CouponList,\r\n    [Popup.name]: Popup\r\n  }\r\n};\r\n</script>\r\n\r\n\r\n<style lang=\"scss\" scoped>\r\n.order-coupon {\r\n  margin-top: 10px;\r\n}\r\n</style>"]}]}